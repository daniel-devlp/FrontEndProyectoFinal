/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * üß≠ COMPONENTE DE NAVEGACI√ìN PRINCIPAL
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Este componente implementa la barra de navegaci√≥n principal de la aplicaci√≥n,
 * proporcionando acceso a todas las secciones seg√∫n el rol del usuario.
 * 
 * üéØ FUNCIONALIDADES PRINCIPALES:
 * ‚Ä¢ Navegaci√≥n adaptativa seg√∫n roles y permisos del usuario
 * ‚Ä¢ Men√∫ responsive para dispositivos m√≥viles y desktop
 * ‚Ä¢ Indicador de estado de conexi√≥n online/offline
 * ‚Ä¢ Informaci√≥n del usuario autenticado en tiempo real
 * ‚Ä¢ Logout seguro con limpieza de sesi√≥n
 * ‚Ä¢ Manejo de teclado para accesibilidad (ESC para cerrar men√∫)
 * ‚Ä¢ Cierre autom√°tico de men√∫ al cambiar de ruta
 * 
 * üîß CARACTER√çSTICAS T√âCNICAS:
 * ‚Ä¢ Integraci√≥n con sistema de autenticaci√≥n y autorizaci√≥n
 * ‚Ä¢ Manejo de eventos de conectividad del navegador
 * ‚Ä¢ Responsive design con breakpoints para m√≥viles
 * ‚Ä¢ Animaciones CSS para mejor experiencia de usuario
 * ‚Ä¢ Event listeners optimizados con cleanup autom√°tico
 * ‚Ä¢ Integraci√≥n con React Router para navegaci√≥n SPA
 * 
 * üöÄ MEJORAS FUTURAS SUGERIDAS:
 * ‚Ä¢ Notificaciones en tiempo real integradas en la navbar
 * ‚Ä¢ Avatar personalizable del usuario con foto de perfil
 * ‚Ä¢ Breadcrumbs din√°micos seg√∫n la ruta actual
 * ‚Ä¢ B√∫squeda global con autocompletado
 * ‚Ä¢ Accesos directos configurables por usuario
 * ‚Ä¢ Modo oscuro/claro con toggle
 * ‚Ä¢ Indicadores de badges para notificaciones pendientes
 * ‚Ä¢ Men√∫ contextual con acciones r√°pidas
 * ‚Ä¢ Integraci√≥n con sistemas de help desk
 * ‚Ä¢ Shortcuts de teclado personalizables
 * ‚Ä¢ Multi-idioma con selector de idioma
 * ‚Ä¢ Integraci√≥n con sistemas de chat interno
 * 
 * üí° ESTRUCTURA DEL MEN√ö:
 * ```
 * Admin: Dashboard ‚Üí Users ‚Üí Roles ‚Üí Clients ‚Üí Products ‚Üí Invoices
 * User:  Dashboard ‚Üí Clients ‚Üí Products ‚Üí Invoices
 * ```
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

import React, { useEffect, useState } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { notifications } from '../../utils/notifications';
import './../../assets/styles/Navbar.css';
import { authService } from '../../services/authService';
import { useAuth } from '../../hooks/useAuth';

 /**
 * üß≠ COMPONENTE PRINCIPAL DE NAVEGACI√ìN
 * 
 * Renderiza la barra de navegaci√≥n principal con men√∫s adaptativos,
 * informaci√≥n del usuario y controles de sesi√≥n.
 * 
 * @returns {JSX.Element} Elemento JSX de la barra de navegaci√≥n
 */
const Navbar: React.FC = () => {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìä ESTADOS DEL COMPONENTE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /** üë§ Nombre del usuario autenticado */
  const [username, setUsername] = useState('Usuario');
  
  /** üì± Estado del men√∫ m√≥vil (abierto/cerrado) */
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  /** üåê Estado de conectividad a internet */
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  
  /** üé≠ Datos de autenticaci√≥n y permisos del usuario actual */
  const { selectedRole, canAccess } = useAuth();
  
  /** üìç Ubicaci√≥n actual en la aplicaci√≥n */
  const location = useLocation();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üöÄ EFECTOS Y INICIALIZACI√ìN
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * üë§ EFECTO PARA CARGAR INFORMACI√ìN DEL USUARIO
   * 
   * Se ejecuta una vez al montar el componente para obtener el nombre
   * del usuario autenticado desde el servicio de autenticaci√≥n.
   */
  useEffect(() => {
    /**
     * üîÑ Funci√≥n as√≠ncrona para obtener datos del usuario
     * Maneja errores de forma elegante y proporciona fallbacks
     */
    const fetchUsername = async () => {
      try {
        const data = await authService.getCurrentUser();
        setUsername(data.userName || 'Usuario');
      } catch (error) {
        // üîç Log para debugging sin exponer informaci√≥n sensible
        console.error('Error fetching username:', error);
        notifications.error('Error al obtener informaci√≥n del usuario');
        setUsername('Usuario'); // üîÑ Fallback en caso de error
      }
    };

    fetchUsername();
  }, []);

  // Monitorear estado de conexi√≥n
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // Cerrar men√∫ al cambiar de ruta
  useEffect(() => {
    setIsMenuOpen(false);
  }, [location]);

  // Cerrar men√∫ con ESC
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape' && isMenuOpen) {
        setIsMenuOpen(false);
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isMenuOpen]);
  const handleLogout = async () => {
    try {
      await authService.logout();
      notifications.success('Sesi√≥n cerrada exitosamente');
      window.location.href = "/";
    } catch (error) {
      console.error("Error during logout:", error);
      notifications.error('Error al cerrar sesi√≥n');
    }
  };

  const toggleMenu = () => {
    setIsMenuOpen(!isMenuOpen);
  };

  const closeMenu = () => {
    setIsMenuOpen(false);
  };

  const getRoleDisplayName = (role: string | null) => {
    if (!role) return '';
    switch (role.toLowerCase()) {
      case 'administrator':
        return 'Admin';
      case 'user':
        return 'Usuario';
      default:
        return role;
    }
  };

  const getMenuItems = () => {
    if (canAccess(['Administrator'])) {
      // Men√∫ para Administrador
      return [
        { path: '/admin/clients', label: 'Clientes', icon: 'üë•' },
        { path: '/admin/products', label: 'Productos', icon: 'üì¶' },
        { path: '/admin/users', label: 'Usuarios', icon: 'üë§' },
        //{ path: '/admin/roles', label: 'Roles', icon: 'üîë' },
        { path: '/admin/invoices', label: 'Facturas', icon: 'üìã' },
        { path: '/factura/nueva', label: 'Crear Factura', icon: '‚ûï' }
      ];
    } else if (canAccess(['user'])) {
      // Men√∫ para Usuario normal
      return [
        { path: '/user/clients', label: 'Clientes', icon: 'üë•' },
        { path: '/user/products', label: 'Productos', icon: 'üì¶' },
        { path: '/user/invoices', label: 'Facturas', icon: 'üìã' },
        { path: '/user/invoices/create', label: 'Crear Factura', icon: '‚ûï' }
      ];
    }
    return [];
  };

  const getDashboardPath = () => {
    if (canAccess(['Administrator'])) {
      return '/admin';
    } else if (canAccess(['user'])) {
      return '/user/dashboard';
    }
    return '/';
  };

  const menuItems = getMenuItems();
  const dashboardPath = getDashboardPath();
  
  return (
    <>
      {/* Bot√≥n hamburguesa para m√≥viles */}
      <button 
        className="mobile-menu-toggle"
        onClick={toggleMenu}
        aria-label="Toggle menu"
        aria-expanded={isMenuOpen}
      >
        <span className={`hamburger-line ${isMenuOpen ? 'open' : ''}`}></span>
        <span className={`hamburger-line ${isMenuOpen ? 'open' : ''}`}></span>
        <span className={`hamburger-line ${isMenuOpen ? 'open' : ''}`}></span>
      </button>

      {/* Overlay para cerrar el men√∫ en m√≥viles */}
      {isMenuOpen && (
        <div 
          className="mobile-overlay" 
          onClick={closeMenu}
          aria-hidden="true"
        ></div>
      )}

      {/* Sidebar/Navbar */}
      <div className={`sidebar ${isMenuOpen ? 'mobile-open' : ''}`}>
        {/* Header del sidebar */}
        <div className="sidebar-header">
          <div className="user-info">
            <div className="user-avatar">
              {username.charAt(0).toUpperCase()}
            </div>
            <div className="user-details">
              <p className="username">{username}</p>
              <p className="user-role">
                {getRoleDisplayName(selectedRole)}
              </p>
              <p className={`user-status ${isOnline ? 'online' : 'offline'}`}>
                <span className={`status-indicator ${isOnline ? 'online' : 'offline'}`}></span>
                {isOnline ? 'Online' : 'Offline'}
              </p>
            </div>
          </div>
          
          <h2 
            className="sidebar-title"
            onClick={() => {
              window.location.href = dashboardPath;
              closeMenu();
            }}
            role="button"
            tabIndex={0}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                window.location.href = dashboardPath;
                closeMenu();
              }
            }}
          >
            {canAccess(['Administrator']) ? 'üè¢ Admin Panel' : 'üë§ Panel Usuario'}
          </h2>
        </div>
        
        {/* Men√∫ de navegaci√≥n */}
        <nav className="sidebar-nav" role="navigation" aria-label="Main navigation">
          <ul className="menu-list">
            {menuItems.map((item, index) => (
              <li key={index} className={`menu-item ${location.pathname === item.path ? 'active' : ''}`}>
                <Link 
                  to={item.path} 
                  className="menu-link"
                  onClick={closeMenu}
                  aria-current={location.pathname === item.path ? 'page' : undefined}
                >
                  <span className="menu-icon" aria-hidden="true">{item.icon}</span>
                  <span className="menu-label">{item.label}</span>
                </Link>
              </li>
            ))}
          </ul>
        </nav>
        
        {/* Bot√≥n de logout */}
        <div className="sidebar-footer">
          <button 
            onClick={() => {
              handleLogout();
              closeMenu();
            }} 
            className="logout-button"
            aria-label="Cerrar sesi√≥n"
          >
            <span className="logout-icon" aria-hidden="true">üö™</span>
            <span className="logout-text">Cerrar sesi√≥n</span>
          </button>
        </div>
      </div>
    </>
  );
};

export default Navbar;



